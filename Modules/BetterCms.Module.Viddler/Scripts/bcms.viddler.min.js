bettercms.define("bcms.viddler",["bcms.jquery","bcms","bcms.media","bcms.viddler.videos"],function(a,b,e,i){var f={},g={},d={},c={};f.links=d;f.globalization=c;f.selectors=g;function h(l,j,k){i.uploadVideo(l,j);}f.init=function(){console.log("Initializing bcms.viddler module.");e.videoProviderOptions.uploadMediaAction=h;};b.registerInit(f.init);return f;});bettercms.define("bcms.viddler.videos",["bcms.jquery","bcms","bcms.dynamicContent","bcms.modal","bcms.ko.extenders","bcms.messages"],function(a,b,d,l,i,k){var m={},o={templateDataBind:".bcms-file-manager-inner",previewVideo:".bcms-preview-image-frame iframe",previewVideoContainer:".bcms-preview-image-border",previewFailure:".bcms-grid-image-holder",fileUploadingResult:"#jsonResult",},j={uploadVideoDialogUrl:null,getUploadDataUrl:null,saveUploadedVideosUrl:null,videoPreviewUrl:"http://viddler.com/embed/{0}",},h={uploadVideoDialogTitle:null,uploadVideoDialogSaveButtonTitle:null,},p=0,u={Idle:1,RequestingUploadData:2,FailedToGetUploadData:3,UploadingFile:4,UploadingFileFailed:5,Done:6},c="00000000-0000-0000-0000-000000000000";m.links=j;m.globalization=h;function g(){return""+p++;}i.bindingHandlers.fileSelectionChanged={init:function(x,A,v,B,w){var y=i.utils.unwrapObservable(A()),z=i.utils.unwrapObservable(y.property);if(z){a(x).change(function(){if(x.files.length){var C=a(this),D=C.val();B[z](D);}});}},};function e(v,w){var x=this;x.id=v;x.name=w;}function s(x,w){var y=this,v=g();y.fileInputDomId="bcmsFilesUploadInput"+v;y.targetFormDomId="xxx";y.endpoint=i.observable();y.token=i.observable();y.callbackUrl=i.observable();y.fileName=i.observable();y.status=i.observable(u.Idle);y.uploadProgress=i.observable(0);y.failureMessage=i.observableArray([]);y.showFileSelection=i.computed(function(){return y.status()==u.Idle;});y.showProgress=i.computed(function(){return y.status()!=u.Idle;});y.uploadFailed=i.computed(function(){return y.status()==u.FailedToGetUploadData||y.status()==u.UploadingFileFailed;});y.uploadProcessing=i.computed(function(){return y.status()==u.RequestingUploadData||y.status()==u.UploadingFile;});y.uploadCompleted=i.computed(function(){return y.status()==u.Done;});y.onFileSelected=function(z){y.fileName(z);if(z){y.upload();}};y.upload=function(){var z=function(){if(w&&a.isFunction(w)){w(y);}};y.status(u.RequestingUploadData);if(x&&a.isFunction(x)){x(y);}y.requestUploadData(function(A){if(A&&A.Data&&A.Data.Token&&A.Data.Endpoint&&A.Data.CallbackUrl){y.token(A.Data.Token);y.endpoint(A.Data.Endpoint);y.callbackUrl(A.Data.CallbackUrl);y.uploadVideo(function(B){if(B.Success){y.status(u.Done);z();}else{y.status(u.UploadingFileFailed);z();}});}else{y.status(u.FailedToGetUploadData);z();}});};y.requestUploadData=function(z){var A=function(B){if(a.isFunction(z)){z(B);}};a.ajax({type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",cache:false,url:j.getUploadDataUrl,}).done(function(B){A(B);}).fail(function(B){A(b.parseFailedResponse(B));});};y.uploadVideo=function(z){var A=a("#"+y.fileInputDomId).parent("form");var B=a("#"+y.targetFormDomId);if(A&&B){B.on("load",function(){var C=B.contents().find(o.fileUploadingResult).get(0);if(C==null){return;}var D=a.parseJSON(C.innerHTML);if(a.isFunction(z)){z(D);}});A.submit();}};y.onCancelUpload=function(){};}function r(){var v=this;v.rootFolderId=null;v.reuploadMediaId=null;v.subFolders=i.observableArray([]);v.selectedFolder=i.observableArray([]);v.showFolderSelection=i.observable(false);v.isReupload=i.observable(false);v.uploadWorkers=i.observableArray([]);v.activeUploads=i.observableArray([]);v.cancelAllActiveUploads=function(){};v.addNewWorker=function(){v.uploadWorkers.push(new s(v.onStartUpload,v.onFinishUpload));};v.onUpload=function(w){v.addNewWorker();v.activeUploads.push(w);};v.onFinishUpload=function(w){v.activeUploads.remove(w);};v.addNewWorker();}m.uploadVideo=function(v,w){var x;l.open({title:h.uploadVideoDialogTitle,acceptTitle:h.uploadVideoDialogSaveButtonTitle,onLoad:function(y){d.setContentFromUrl(y,j.uploadVideoDialogUrl,{done:function(z){if(z&&z.Data){x=new r();x.rootFolderId=z.Data.RootFolderId;x.reuploadMediaId=z.Data.ReuploadMediaId;if(z.Data.Folders){for(var C in z.Data.Folders){var B=z.Data.Folders[C];x.subFolders.push(new e(B.Item1,B.Item2));}}x.showFolderSelection(x.reuploadMediaId==c);var A=y.container.find(o.templateDataBind).get(0);if(A){i.applyBindings(x,A);}}}});},onAccept:function(y){n(v,x,function(z){if(w&&a.isFunction(w)){w(z);}y.close();});return false;}});};function n(w,B,A,v){return;var x="medialist",z={FolderId:w,VideoIds:null},y=function(C){A.hideLoading(x);if(a.isFunction(v)){v(C);}};A.showLoading(x);a.ajax({type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",cache:false,url:j.saveUploadedVideosUrl,data:JSON.stringify(z)}).done(function(C){y(C);}).fail(function(C){y(b.parseFailedResponse(C));});}function t(D,G,y,C){C=a.extend({},C);C.templateId="bcms-video-preview-template";C.disableAnimation=true;var w=l.open(C),z=w.container.find(o.previewVideo),A=w.container.find(o.previewVideoContainer),x=false,F=a(window).width()-150,E=a(window).height()-150,v=(1*G)/(1*y);if(G>F){G=F;y=Math.round(G/v);}if(y>E){y=E;G=Math.round(y*v);}z.attr("width",G+"px");z.attr("height",y+"px");var B=(G+60)/-2;A.css("width",G+"px");A.css("margin-left",B+"px");z.on("load",function(){x=true;A.find(l.selectors.loader).hide();z.show();});z.on("error",function(){if(!x){var H=w.container.find(o.previewVideoContainer),I=H.find(o.previewFailure);H.find(o.loader).hide();I.show();}});z.attr("src",D);return w;}function q(v){return v.toFixed(1).replace(/\.0+$/,"");}function f(y){var w=1024,x=Math.pow(w,2),v=Math.pow(w,3);if(y<w){return y+" B";}if(y<x){return q(y/w)+" KB";}if(y<v){return q(y/x)+" MB";}return q(y/v)+" GB";}m.init=function(){console.log("Initializing bcms.viddler.videos module.");};b.registerInit(m.init);return m;});