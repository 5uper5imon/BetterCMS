bettercms.define("bcms.viddler",["bcms.jquery","bcms","bcms.media","bcms.viddler.videos"],function(a,b,e,i){var f={},g={},d={},c={};f.links=d;f.globalization=c;f.selectors=g;function h(l,j,k){i.uploadVideo(l,j);}f.init=function(){console.log("Initializing bcms.viddler module.");e.videoProviderOptions.uploadMediaAction=h;};b.registerInit(f.init);return f;});bettercms.define("bcms.viddler.videos",["bcms.jquery","bcms","bcms.dynamicContent","bcms.modal","bcms.ko.extenders","bcms.messages"],function(a,b,c,k,h,j){var l={},n={templateDataBind:".bcms-file-manager-inner",previewVideo:".bcms-preview-image-frame iframe",previewVideoContainer:".bcms-preview-image-border",previewFailure:".bcms-grid-image-holder",},i={uploadVideoDialogUrl:null,saveUploadedVideosUrl:null,videoPreviewUrl:"http://viddler.com/embed/{0}",},g={uploadVideoDialogTitle:null,uploadVideoDialogSaveButtonTitle:null,},o=0,t={Idle:1,RequestingUploadData:2,FailedToGetUploadData:3,UploadingFile:4,UploadingFileFailed:5,Done:6};l.links=i;l.globalization=g;function f(){return"_"+o++;}h.bindingHandlers.fileSelectionChanged={init:function(w,z,u,A,v){var x=h.utils.unwrapObservable(z()),y=h.utils.unwrapObservable(x.property);if(y){a(w).change(function(){if(w.files.length){var B=a(this),C=B.val(),D=B.files;A[y](C,D);}});}},};function d(){var u=this;u.id="";u.name="";}function r(){var u=this;u.fileInputDomId="bcms-files-upload-input"+f();u.endpoint=h.observable();u.token=h.observable();u.callbackUrl=h.observable();u.fileName=h.observable();u.fileSize=h.observable();u.fileSizeFormated=h.computed(function(){return e(u.fileSize());});u.status=h.observable(t.Idle);u.uploadProgress=h.observable(0);u.failureMessage=h.observableArray([]);u.showFileSelection=h.computed(function(){return u.status()==t.Idle;});u.showProgress=h.computed(function(){return u.status()!=t.Idle;});u.uploadFailed=h.computed(function(){return u.status()==t.FailedToGetUploadData||u.status()==t.UploadingFileFailed;});u.uploadProcessing=h.computed(function(){return u.status()==t.RequestingUploadData||u.status()==t.UploadingFileFailed;});u.uploadCompleted=h.computed(function(){return u.status()==t.Done;});u.onFileSelected=function(v,w){if(w!=null&&w.length>0){u.fileName(w[0].name);u.fileSize(w[0].size);}else{u.fileName(v);}if(u.fileName()){u.upload();}};u.upload=function(){u.status(t.RequestingUploadData);u.status(t.Done);};u.onCancelUpload=function(){};}function q(){var u=this;u.subFolders=h.observableArray([]);u.selectedFolder=h.observableArray([]);u.showFolderSelection=h.observable(false);u.isReupload=h.observable(false);u.uploadWorkers=h.observableArray([new r()]);u.activeUploads=h.observableArray([]);u.cancelAllActiveUploads=function(){};}l.uploadVideo=function(u,w){var v;k.open({title:g.uploadVideoDialogTitle,acceptTitle:g.uploadVideoDialogSaveButtonTitle,onLoad:function(x){c.setContentFromUrl(x,i.uploadVideoDialogUrl,{done:function(y){var A=new q();var z=x.container.find(n.templateDataBind).get(0);if(z){h.applyBindings(A,z);}}});},onAccept:function(x){m(u,v,function(y){if(w&&a.isFunction(w)){w(y);}x.close();});return false;}});};function m(v,A,z,u){var w="medialist",y={FolderId:v,VideoId:A},x=function(B){z.hideLoading(w);if(a.isFunction(u)){u(B);}};z.showLoading(w);a.ajax({type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",cache:false,url:i.saveUploadedVideosUrl,data:JSON.stringify(y)}).done(function(B){x(B);}).fail(function(B){x(b.parseFailedResponse(B));});}function s(C,F,x,B){B=a.extend({},B);B.templateId="bcms-video-preview-template";B.disableAnimation=true;var v=k.open(B),y=v.container.find(n.previewVideo),z=v.container.find(n.previewVideoContainer),w=false,E=a(window).width()-150,D=a(window).height()-150,u=(1*F)/(1*x);if(F>E){F=E;x=Math.round(F/u);}if(x>D){x=D;F=Math.round(x*u);}y.attr("width",F+"px");y.attr("height",x+"px");var A=(F+60)/-2;z.css("width",F+"px");z.css("margin-left",A+"px");y.on("load",function(){w=true;z.find(k.selectors.loader).hide();y.show();});y.on("error",function(){if(!w){var G=v.container.find(n.previewVideoContainer),H=G.find(n.previewFailure);G.find(n.loader).hide();H.show();}});y.attr("src",C);return v;}function p(u){return u.toFixed(1).replace(/\.0+$/,"");}function e(x){var v=1024,w=Math.pow(v,2),u=Math.pow(v,3);if(x<v){return x+" B";}if(x<w){return p(x/v)+" KB";}if(x<u){return p(x/w)+" MB";}return p(x/u)+" GB";}l.init=function(){console.log("Initializing bcms.viddler.videos module.");};b.registerInit(l.init);return l;});